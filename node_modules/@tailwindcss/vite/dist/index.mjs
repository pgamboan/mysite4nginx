import{compile as U,env as h,Features as b,normalizePath as D}from"@tailwindcss/node";import{clearRequireCache as F}from"@tailwindcss/node/require-cache";import{Scanner as P}from"@tailwindcss/oxide";import{Features as x,transform as G}from"lightningcss";import A from"node:fs/promises";import v from"node:path";var M=/[?&](raw|url)\b/;function V(){let s=[],i=null,o=!1,u=!1,c=new C(()=>new Set),p=new P({}),a=new C(e=>{let t=i.createResolver({...i.resolve,extensions:[".css"],mainFields:["style"],conditions:["style","development|production"],tryIndex:!1,preferRelative:!0});function n(f,m){return t(f,m,!0,o)}let l=i.createResolver(i.resolve);function r(f,m){return l(f,m,!0,o)}return new R(e,()=>c,i.base,n,r)});function d(e,t,n,l){let r=!1;for(let f of p.scanFiles([{content:t,extension:n}]))r=!0,c.get(e).add(f);r&&g(l)}function g(e){for(let t of s){let n=[];for(let[l,r]of a.entries()){let f=t.moduleGraph.getModuleById(l);if(!f){if(r.builtBeforeTransform)continue;e||a.delete(l);continue}a.get(l).requiresRebuild=!1,t.moduleGraph.invalidateModule(f),n.push({type:`${f.type}-update`,path:f.url,acceptedPath:f.url,timestamp:Date.now()})}n.length>0&&t.hot.send({type:"update",updates:n})}}async function w(e,t){let n=e.lastContent,l=await e.generate(n,t);if(l===!1)return;h.DEBUG&&console.time("[@tailwindcss/vite] Optimize CSS");let r=q(l,{minify:u});return h.DEBUG&&console.timeEnd("[@tailwindcss/vite] Optimize CSS"),r}async function E(e,t,n){let l={...e,getCombinedSourcemap:()=>{throw new Error("getCombinedSourcemap not implemented")}};for(let r of i.plugins){if(!r.transform||r.name.startsWith("@tailwindcss/"))continue;if(r.name.startsWith("vite:")&&r.name!=="vite:css"&&r.name!=="vite:css-post"&&r.name!=="vite:vue")continue;if(r.name==="ssr-styles")continue;let f="handler"in r.transform?r.transform.handler:r.transform;try{let m=await f.call(l,n,t);if(!m)continue;typeof m=="string"?n=m:m.code&&(n=m.code)}catch{console.error(`Error running ${r.name} on Tailwind CSS output. Skipping.`)}}return n}return[I(a),{name:"@tailwindcss/vite:scan",enforce:"pre",configureServer(e){s.push(e)},async configResolved(e){i=e,u=i.build.cssMinify!==!1,o=i.build.ssr!==!1&&i.build.ssr!==void 0},transformIndexHtml(e,{path:t}){d(t,e,"html",o)},transform(e,t,n){let l=B(t);y(t)||d(t,e,l,n?.ssr??!1)}},{name:"@tailwindcss/vite:generate:serve",apply:"serve",enforce:"pre",async transform(e,t,n){if(!y(t))return;let l=a.get(t);if(l.builtBeforeTransform&&(l.builtBeforeTransform.forEach(f=>this.addWatchFile(f)),l.builtBeforeTransform=void 0),S(t))return e;n?.ssr||await Promise.all(s.map(f=>f.waitForRequestsIdle(t)));let r=await l.generate(e,f=>this.addWatchFile(f));return r?{code:r}:(a.delete(t),e)}},{name:"@tailwindcss/vite:generate:build",apply:"build",enforce:"pre",async transform(e,t){if(!y(t))return;let n=a.get(t);if(n.builtBeforeTransform&&(n.builtBeforeTransform.forEach(r=>this.addWatchFile(r)),n.builtBeforeTransform=void 0),S(t))return e;let l=await n.generate(e,r=>this.addWatchFile(r));return l?{code:l}:(a.delete(t),e)},async renderStart(){for(let[e,t]of a.entries()){if(S(e))continue;let n=await w(t,()=>{});if(!n){a.delete(e);continue}await E(this,e,n)}}}]}function B(s){let[i]=s.split("?",2);return v.extname(i).slice(1)}function y(s){if(s.includes("/.vite/"))return;let i=B(s);return(i==="css"||i==="vue"&&s.includes("&lang.css")||i==="astro"&&s.includes("&lang.css")||S(s))&&!M.test(s)}function S(s){return B(s)==="svelte"&&s.includes("&lang.css")}function q(s,{file:i="input.css",minify:o=!1}={}){function u(c){return G({filename:i,code:c,minify:o,sourceMap:!1,drafts:{customMedia:!0},nonStandard:{deepSelectorCombinator:!0},include:x.Nesting,exclude:x.LogicalProperties,targets:{safari:16<<16|1024,ios_saf:16<<16|1024,firefox:8388608,chrome:7864320},errorRecovery:!0}).code}return u(u(Buffer.from(s))).toString()}function T(s){return v.resolve(s.replace(/\?.*$/,""))}var C=class extends Map{constructor(o){super();this.factory=o}get(o){let u=super.get(o);return u===void 0&&(u=this.factory(o,this),this.set(o,u)),u}},R=class{constructor(i,o,u,c,p){this.id=i;this.getSharedCandidates=o;this.base=u;this.customCssResolver=c;this.customJsResolver=p}lastContent="";builtBeforeTransform;compiler;requiresRebuild=!0;scanner;candidates=new Set;dependencies=new Set;basePath=null;overwriteCandidates=null;async generate(i,o){this.lastContent=i;let u=T(this.id),c=v.dirname(v.resolve(u));if(!this.compiler||!this.scanner||this.requiresRebuild){F(Array.from(this.dependencies)),this.dependencies=new Set([T(u)]),h.DEBUG&&console.time("[@tailwindcss/vite] Setup compiler"),this.compiler=await U(i,{base:c,shouldRewriteUrls:!0,onDependency:d=>{o(d),this.dependencies.add(d)},customCssResolver:this.customCssResolver,customJsResolver:this.customJsResolver}),h.DEBUG&&console.timeEnd("[@tailwindcss/vite] Setup compiler");let a=(this.compiler.root==="none"?[]:this.compiler.root===null?[]:[this.compiler.root]).concat(this.compiler.globs);this.scanner=new P({sources:a})}if(!(this.compiler.features&(b.AtApply|b.JsPluginCompat|b.ThemeFunction|b.Utilities)))return!1;if(!this.overwriteCandidates||this.compiler.features&b.Utilities){h.DEBUG&&console.time("[@tailwindcss/vite] Scan for candidates");for(let a of this.scanner.scan())this.candidates.add(a);h.DEBUG&&console.timeEnd("[@tailwindcss/vite] Scan for candidates")}if(this.compiler.features&b.Utilities){for(let a of this.scanner.files)o(a);for(let a of this.scanner.globs){if(a.pattern[0]==="!")continue;let d=v.relative(this.base,a.base);d[0]!=="."&&(d="./"+d),d=D(d),o(v.posix.join(d,a.pattern));let g=this.compiler.root;if(g!=="none"&&g!==null){let w=D(v.resolve(g.base,g.pattern));if(!await A.stat(w).then(e=>e.isDirectory(),()=>!1))throw new Error(`The path given to \`source(\u2026)\` must be a directory but got \`source(${w})\` instead.`);this.basePath=w}else g===null&&(this.basePath=null)}}this.requiresRebuild=!0,h.DEBUG&&console.time("[@tailwindcss/vite] Build CSS");let p=this.compiler.build(this.overwriteCandidates?this.overwriteCandidates:[...this.sharedCandidates(),...this.candidates]);return h.DEBUG&&console.timeEnd("[@tailwindcss/vite] Build CSS"),p}sharedCandidates(){if(!this.compiler)return new Set;if(this.compiler.root==="none")return new Set;let i=/^[A-Z]:/,o=c=>this.basePath===null||c.startsWith(this.basePath)?!0:i.test(c)?!1:!c.startsWith("/"),u=new Set;for(let[c,p]of this.getSharedCandidates())if(o(c))for(let a of p)u.add(a);return u}};function I(s){return{name:"@tailwindcss/svelte",api:{sveltePreprocess:{async style({content:i,filename:o,markup:u}){if(!o)return;let c=o+"?svelte&type=style&lang.css",p=s.get(c);p.requiresRebuild=!0,p.builtBeforeTransform=[];let a=new P({});p.overwriteCandidates=a.scanFiles([{content:u,file:o,extension:"svelte"}]);let d=await p.generate(i,g=>p.builtBeforeTransform?.push(g));if(!d){s.delete(c);return}return{code:d}}}}}}export{V as default};
